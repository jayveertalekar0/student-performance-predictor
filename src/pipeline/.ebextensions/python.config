# .ebextensions/01_python.config
option_settings:
  aws:elasticbeanstalk:container:python:
    WSGIPath: application:app
    NumProcesses: 3
    NumThreads: 20
  
  aws:elasticbeanstalk:application:environment:
    PYTHONPATH: "/var/app/current:$PYTHONPATH"
    STREAMLIT_SERVER_PORT: "8080"
    STREAMLIT_SERVER_ADDRESS: "0.0.0.0"
    STREAMLIT_SERVER_HEADLESS: "true"
    STREAMLIT_BROWSER_SERVER_ADDRESS: "0.0.0.0"
    STREAMLIT_BROWSER_GATHER_USAGE_STATS: "false"
  
  aws:elasticbeanstalk:environment:proxy:
    ProxyServer: nginx
  
  aws:autoscaling:launchconfiguration:
    IamInstanceProfile: aws-elasticbeanstalk-ec2-role
  
  aws:elasticbeanstalk:healthreporting:system:
    SystemType: enhanced

packages:
  yum:
    python3-devel: []
    gcc: []
    gcc-c++: []
    make: []
    openssl-devel: []
    bzip2-devel: []
    libffi-devel: []
    postgresql-devel: []
    mysql-devel: []

container_commands:
  01_install_streamlit:
    command: |
      source /var/app/venv/*/bin/activate
      pip install --upgrade pip
      pip install streamlit pandas numpy scikit-learn catboost xgboost
  02_create_nginx_conf:
    command: |
      cat > /etc/nginx/conf.d/streamlit.conf << EOF
      upstream streamlit {
        server 127.0.0.1:8080;
      }
      
      server {
        listen 80;
        
        location / {
          proxy_pass http://streamlit;
          proxy_http_version 1.1;
          proxy_set_header Upgrade \$http_upgrade;
          proxy_set_header Connection "upgrade";
          proxy_set_header Host \$host;
          proxy_set_header X-Real-IP \$remote_addr;
          proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto \$scheme;
          proxy_read_timeout 86400;
        }
        
        location /_stcore/ {
          proxy_pass http://streamlit;
          proxy_http_version 1.1;
          proxy_set_header Upgrade \$http_upgrade;
          proxy_set_header Connection "upgrade";
          proxy_set_header Host \$host;
          proxy_set_header X-Real-IP \$remote_addr;
          proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto \$scheme;
        }
        
        location /health {
          access_log off;
          return 200 "healthy\n";
        }
      }
      EOF
  03_restart_nginx:
    command: "service nginx restart"